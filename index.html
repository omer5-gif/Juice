<script>
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById('kitsune-canvas').appendChild(renderer.domElement);
    const kitsune = new THREE.Mesh(new THREE.IcosahedronGeometry(2.2, 1), new THREE.MeshPhongMaterial({ color: 0x8a2be2, wireframe: true }));
    scene.add(kitsune); scene.add(new THREE.PointLight(0xffffff, 1, 100)); camera.position.z = 5;
    function animate() { requestAnimationFrame(animate); kitsune.rotation.y += 0.01; renderer.render(scene, camera); }
    animate();

    async function startRVC() {
        const log = document.getElementById('status-log');
        const fileInput = document.getElementById('songUpload');
        const audioOut = document.getElementById('finalAudio');
        const file = fileInput.files[0];
        
        if (!file) {
            log.innerText = "Error: Please upload a file first.";
            return;
        }

        log.innerText = "Step 1: Processing " + file.name + "...";

        try {
            // יצירת קישור זמני לקובץ שהעלית כדי שהנגן יעבוד מיד
            const blobURL = URL.createObjectURL(file);
            audioOut.src = blobURL;

            log.innerText = "Step 2: Isolating vocals & applying Juice WRLD RVC...";
            
            // סימולציית עיבוד AI (כאן מתחבר ה-Token בשלב הבא)
            setTimeout(() => {
                log.innerText = "Step 3: Conversion Complete! Playing AI Cover.";
                
                const msg = new SpeechSynthesisUtterance("RVC Model applied to " + file.name);
                msg.pitch = 0.6; msg.rate = 0.8;
                window.speechSynthesis.speak(msg);

                audioOut.style.display = "block";
                audioOut.play(); // עכשיו זה ינגן!
            }, 3000);

        } catch (e) {
            log.innerText = "RVC processing failed. Try a smaller file.";
        }
    }
</script>
